apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: authelia
data:
  configuration.yml: |
    ---
    theme: light
    default_redirection_url: https://home.mcztest.com

    server:
      host: 0.0.0.0
      port: 9091

    log:
      level: info

    totp:
      issuer: home.mcztest.com
      period: 30
      skew: 1

    webauthn:
      disable: false
      display_name: Homelab
      attestation_conveyance_preference: indirect
      timeout: 60s

    authentication_backend:
      file:
        path: /config/users_database.yml
        password:
          algorithm: argon2id
          iterations: 1
          key_length: 32
          salt_length: 16
          memory: 64
          parallelism: 8

    access_control:
      default_policy: deny
      rules:
        # Bypass Authelia for git operations (git push/pull)
        - domain: gitea.home.mcztest.com
          resources:
            - "^/.*/info/refs.*$"
            - "^/.*/git-upload-pack$"
            - "^/.*/git-receive-pack$"
            - "^/.*/HEAD$"
            - "^/.*/objects/.*$"
          policy: bypass

        # Bypass Authelia for Gitea API (used by automation/CI)
        - domain: gitea.home.mcztest.com
          resources:
            - "^/api/v1/.*$"
          policy: bypass

        # Bypass Authelia for registry API read operations (used by dashboard)
        - domain: registry-api.home.mcztest.com
          resources:
            - "^/api/v1/apps$"
            - "^/health$"
          policy: bypass

        # All services require two-factor authentication
        - domain: home.mcztest.com
          policy: two_factor

        - domain: argocd.home.mcztest.com
          policy: two_factor

        - domain: gitea.home.mcztest.com
          policy: two_factor

        - domain: pihole.home.mcztest.com
          policy: two_factor

        - domain: registry.home.mcztest.com
          policy: two_factor

        - domain: registry-api.home.mcztest.com
          policy: two_factor

        - domain: desktop.home.mcztest.com
          policy: two_factor

    session:
      name: authelia_session
      domain: home.mcztest.com
      same_site: lax
      expiration: 12h
      inactivity: 4h
      remember_me: 30d
      redis:
        host: redis
        port: 6379

    regulation:
      max_retries: 100
      find_time: 5m
      ban_time: 10m

    storage:
      local:
        path: /config/db.sqlite3

    notifier:
      smtp:
        host: smtp.gmail.com
        port: 587
        username: mzakany@gmail.com
        sender: "Authelia <mzakany@gmail.com>"
        subject: "[Authelia] {title}"
        startup_check_address: mzakany@gmail.com
        disable_require_tls: false
        disable_html_emails: false
        tls:
          skip_verify: false
